## redis数据同步

redis 有两种持久化方式，分别是RDB(快照) 和AOF(文件追加)，如果redis发生宕机，则可以通过重新读入RDB文件和回放日志的方式恢复数据，从而保证尽量的少丢数据，提高可靠性。

### redis 主从模式

redis提供了主从模式，以保证数据副本一致，主从库之间采用的是读写分离模式。

* 读操作：主库，从库都可以接收
* 写操作：到主库上执行，然后主库将数同步给从库

<img src="../img/06/redis-leader-follower.jpg" width="500px">

### 为什么采用读写分离的方式？

如上图所示，不管主库还是从库如果都可以接收客户端的写操作，而客户端对同一个数据k1前后做了三次修改，每次的修改请求发到了不同的实例上，在不同的实例上执行，那么这三个数据在三个实例上的数据就不一致了（分别是 v1,v2,v3）。在读取这个数据的时候，就有可能读取到旧数据的值。

如果我们硬要保持这三个实例上的数据一致，就要涉及都加锁、实例间协商是否完成修改等一系列操作，会带来巨大的开销。

而主从模式旦采用读写分离之后，所有数据的修改只会在主库上进行，不用协调三个实例。主库有了最新的数据后，会同步给从库，这样主从库的数据就是一致的了。

### 主从同步如何完成

当我们启动多个Redis实例的时候，它们之间就可以通过replicaof（Redis 5.0之前使用slaveof）命令形成主库和从库的关系，之后会按照三个阶段完成数据的第一次同步。

例如：现在有 现在有实例1，ip(192.16.19.3) 和实例2(192.16.19.5)，在实例2上执行以下命令后，实例2就变成了实例1的从库，并从实例1上复制数据：
```
REPLICAOF 192.16.19.3 3306
```

**三阶段数据同步**

<img src="../img/06/replica-first.png">

第一阶段主要是主从库间建立连接，协商同步的过程，主要是为全量复制做准备。在这一步，从库和主库建立起连接，并告诉主库即将进行同步，主库确认回复后，主从库间就开始同步了。

从库会给主库发送一个psync命令，表示要进行数据同步，主库根据这个命令参数来启动复制。psync包含两个参数，一个主库的runID和复制进度offset两个参数。




